<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Product Management | Infinity Electronics</title>
  <link rel="stylesheet" href="Styles/navbar.css" />
  <link rel="stylesheet" href="Styles/adminProduct.css" />
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="brand">Infinity Electronics</div>
    <button class="menu-toggle" id="menuToggle">☰</button>
    <div class="nav-actions" id="navLinks">
      <a href="adminProduct.html" class="active">Products</a>
      <a href="orderManagement.html">Orders</a>
      <a href="addUser.html">Users</a>
      <a href="admin_feedback.html">Feedback</a>
      <a href="../login.html" class="logout">Logout</a>
    </div>
  </nav>

  <!-- MAIN CONTAINER -->
  <div class="container">
    <h2>Manage Product</h2>

    <!-- PRODUCT FORM -->
    <form id="addItemForm" class="form" enctype="multipart/form-data">
      <input type="hidden" id="editProductId">

      <div class="form-group">
        <label>Product Name</label>
        <input type="text" id="itemName" required>
      </div>

      <div class="form-group">
        <label>Model</label>
        <input type="text" id="itemModel" required>
      </div>

      <div class="form-group">
        <label>Upload Product Image</label>
        <input type="file" id="itemImage" accept="image/*" required>
        <div id="currentImageContainer" style="display:none;margin-top:10px;">
          <label>Current Image:</label>
          <img id="currentImage" style="max-width:150px;display:block;margin-top:5px;">
        </div>
      </div>

      <div class="form-group">
        <label>Category</label>
        <select id="itemCategory" required>
          <option value="">Select Category</option>
          <option>Fan</option>
          <option>Mobile</option>
          <option>Refrigerator</option>
          <option>Bike</option>
          <option>Washing Machine</option>
          <option>Dryer</option>
        </select>
      </div>

      <div class="form-group">
        <label>Warranty</label>
        <input type="text" id="itemWarranty" required>
      </div>

      <div class="form-group">
        <label>Units</label>
        <input type="number" id="itemUnits" min="0" required>
      </div>

      <div class="form-group">
        <label>Price (PKR)</label>
        <input type="number" id="itemPrice" min="0" required>
      </div>

      <div class="form-group">
        <label>Description</label>
        <textarea id="itemDescription" rows="3" required></textarea>
      </div>

      <button type="submit" id="formBtn" class="btn">Add Item</button>
    </form>

    <h2>All Products</h2>
    <div id="productList" class="product-list"></div>
  </div>

  <footer>
    <p>© 2025 Infinity Electronics</p>
  </footer>

  <!-- SCRIPT -->
  <script type="module">
    import "../js/sessionCheck.js";

    const API_URL = "http://localhost:5000/api/products";
    const token = localStorage.getItem("token");

    const form = document.getElementById("addItemForm");
    const productList = document.getElementById("productList");
    const menuToggle = document.getElementById("menuToggle");
    const navLinks = document.getElementById("navLinks");

    /* NAVBAR TOGGLE */
    menuToggle.addEventListener("click", () => navLinks.classList.toggle("show"));

    /* LOAD PRODUCTS ON PAGE LOAD */
    document.addEventListener("DOMContentLoaded", loadProducts);

    /* FORM SUBMIT */
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("editProductId").value;

      const formData = new FormData();
      formData.append("name", itemName.value.trim());
      formData.append("model", itemModel.value.trim());
      formData.append("category", itemCategory.value);
      formData.append("warranty", itemWarranty.value.trim());
      formData.append("units", Number(itemUnits.value));
      formData.append("price", Number(itemPrice.value));
      formData.append("description", itemDescription.value.trim());

      if (itemImage.files[0]) formData.append("image", itemImage.files[0]);

      const res = await fetch(id ? `${API_URL}/${id}` : API_URL, {
        method: id ? "PUT" : "POST",
        headers: { Authorization: "Bearer " + token },
        body: formData
      });

      const data = await res.json();
      if (!res.ok) { alert(data.message || "Operation failed"); return; }

      alert(id ? "Product updated successfully" : "Product added successfully");
      resetForm();
      loadProducts();
    });

    /* LOAD PRODUCTS */
    async function loadProducts() {
      const res = await fetch(API_URL, { headers: { Authorization: "Bearer " + token } });
      const data = await res.json();
      const products = Array.isArray(data) ? data : data.products || [];

      if (!products.length) {
        productList.innerHTML = "<p>No products found.</p>";
        return;
      }

      productList.innerHTML = products.map(p => `
        <div class="product-card" data-id="${p._id}">
          <img src="${p.image}">
          <h3>${p.name}</h3>
          <p><b>Model:</b> ${p.model}</p>
          <p><b>Category:</b> ${p.category}</p>
          <p><b>Price:</b> PKR ${p.price}</p>
          <p><b>Units:</b> ${p.units}</p>
          <p><b>Warranty:</b> ${p.warranty}</p>
          <p>${p.description}</p>
          <button class="edit-btn">Edit</button>
          <button class="delete-btn">Delete</button>
        </div>
      `).join("");

      document.querySelectorAll(".edit-btn").forEach(btn =>
        btn.onclick = () => editProduct(btn.closest(".product-card").dataset.id)
      );

      document.querySelectorAll(".delete-btn").forEach(btn =>
        btn.onclick = () => deleteProduct(btn.closest(".product-card").dataset.id)
      );
    }

    async function editProduct(id) {
  try {

    const res = await fetch(`${API_URL}/${id}`, {
      headers: { Authorization: "Bearer " + token }
    });

    const result = await res.json();

    if (!result.success) {
      alert(result.message || "Failed to fetch product");
      return;
    }

    const p = result.data;

    document.getElementById("itemName").value = p.name || "";
    document.getElementById("itemModel").value = p.model || "";
    document.getElementById("itemCategory").value = p.category || "";
    document.getElementById("itemWarranty").value = p.warranty || "";
    document.getElementById("itemUnits").value =
      Number.isFinite(p.units) ? p.units : "";
    document.getElementById("itemPrice").value =
      Number.isFinite(p.price) ? p.price : "";
    document.getElementById("itemDescription").value = p.description || "";
    document.getElementById("editProductId").value = p._id;

    if (p.image) {
      currentImageContainer.style.display = "block";
      currentImage.src = p.image;
    } else {
      currentImageContainer.style.display = "none";
    }

    itemImage.required = false;
    formBtn.textContent = "Update Item";

    window.scrollTo({ top: 0, behavior: "smooth" });

  } catch (err) {
    console.error("Edit Product Error:", err);
    alert("Something went wrong while editing");
  }
}



    /* DELETE PRODUCT */
    async function deleteProduct(id) {
      if (!confirm("Delete this product?")) return;
      const res = await fetch(`${API_URL}/${id}`, {
        method: "DELETE",
        headers: { Authorization: "Bearer " + token }
      });
      if (!res.ok) { alert("Delete failed"); return; }
      alert("Product deleted");
      loadProducts();
    }

    /* RESET FORM */
    function resetForm() {
      form.reset();
      editProductId.value = "";
      formBtn.textContent = "Add Item";
      itemImage.required = true;
      currentImageContainer.style.display = "none";
    }

  </script>
</body>
</html>
